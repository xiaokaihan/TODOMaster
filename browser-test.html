<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODOMaster åç«¯APIæµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: bold;
        }
        .status.success { background: #28a745; color: white; }
        .status.error { background: #dc3545; color: white; }
        .status.loading { background: #ffc107; color: black; }
        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ TODOMaster åç«¯APIæµ‹è¯•å·¥å…·</h1>
        <p><strong>APIåŸŸå:</strong> <span id="apiUrl">https://todomaster-backend-1v0k.onrender.com</span></p>
        <p><strong>çŠ¶æ€:</strong> <span id="apiStatus" class="status loading">æ£€æµ‹ä¸­...</span></p>
    </div>

    <!-- åŸºç¡€å¥åº·æ£€æŸ¥ -->
    <div class="container">
        <div class="test-section">
            <h2>1. åŸºç¡€å¥åº·æ£€æŸ¥</h2>
            <button onclick="testBasicHealth()">æµ‹è¯•APIåŸºç¡€çŠ¶æ€</button>
            <button onclick="testHealthEndpoints()">æµ‹è¯•å¥åº·æ£€æŸ¥ç«¯ç‚¹</button>
            <div id="healthResult" class="result info" style="display:none;"></div>
        </div>
    </div>

    <!-- ç”¨æˆ·è®¤è¯æµ‹è¯• -->
    <div class="container">
        <div class="test-section">
            <h2>2. ç”¨æˆ·è®¤è¯æµ‹è¯•</h2>
            
            <h3>ç”¨æˆ·æ³¨å†Œ</h3>
            <div class="form-group">
                <label>é‚®ç®±:</label>
                <input type="email" id="registerEmail" placeholder="test@example.com">
            </div>
            <div class="form-group">
                <label>å¯†ç :</label>
                <input type="password" id="registerPassword" placeholder="Test123456">
            </div>
            <div class="form-group">
                <label>å§“å:</label>
                <input type="text" id="registerFirstName" placeholder="æµ‹è¯•" value="æµ‹è¯•">
                <input type="text" id="registerLastName" placeholder="ç”¨æˆ·" value="ç”¨æˆ·">
            </div>
            <button onclick="testRegister()">æµ‹è¯•ç”¨æˆ·æ³¨å†Œ</button>
            
            <h3>ç”¨æˆ·ç™»å½•</h3>
            <div class="form-group">
                <label>é‚®ç®±:</label>
                <input type="email" id="loginEmail" placeholder="test@example.com">
            </div>
            <div class="form-group">
                <label>å¯†ç :</label>
                <input type="password" id="loginPassword" placeholder="Test123456">
            </div>
            <button onclick="testLogin()">æµ‹è¯•ç”¨æˆ·ç™»å½•</button>
            <button onclick="testGetCurrentUser()" id="getCurrentUserBtn" disabled>è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯</button>
            
            <div id="authResult" class="result info" style="display:none;"></div>
        </div>
    </div>

    <!-- æ ¸å¿ƒåŠŸèƒ½æµ‹è¯• -->
    <div class="container">
        <div class="test-section">
            <h2>3. æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•</h2>
            <p><strong>TokençŠ¶æ€:</strong> <span id="tokenStatus">æœªç™»å½•</span></p>
            
            <button onclick="testObjectives()" id="objectivesBtn" disabled>æµ‹è¯•ç›®æ ‡API</button>
            <button onclick="testKeyResults()" id="keyResultsBtn" disabled>æµ‹è¯•å…³é”®ç»“æœAPI</button>
            <button onclick="testTasks()" id="tasksBtn" disabled>æµ‹è¯•ä»»åŠ¡API</button>
            <button onclick="testStats()" id="statsBtn" disabled>æµ‹è¯•ç»Ÿè®¡API</button>
            
            <div id="coreResult" class="result info" style="display:none;"></div>
        </div>
    </div>

    <!-- å®‰å…¨æ€§æµ‹è¯• -->
    <div class="container">
        <div class="test-section">
            <h2>4. å®‰å…¨æ€§æµ‹è¯•</h2>
            <button onclick="testUnauthorizedAccess()">æµ‹è¯•æœªæˆæƒè®¿é—®</button>
            <button onclick="testInvalidToken()">æµ‹è¯•æ— æ•ˆToken</button>
            
            <div id="securityResult" class="result info" style="display:none;"></div>
        </div>
    </div>

    <!-- æ€§èƒ½æµ‹è¯• -->
    <div class="container">
        <div class="test-section">
            <h2>5. æ€§èƒ½æµ‹è¯•</h2>
            <button onclick="testPerformance()">æµ‹è¯•APIå“åº”æ—¶é—´</button>
            
            <div id="performanceResult" class="result info" style="display:none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://todomaster-backend-1v0k.onrender.com';
        const API_URL = `${API_BASE}/api`;
        let currentToken = '';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            testBasicHealth();
            // ç”Ÿæˆéšæœºé‚®ç®±
            const randomEmail = `test_${Date.now()}@example.com`;
            document.getElementById('registerEmail').value = randomEmail;
            document.getElementById('loginEmail').value = randomEmail;
        });

        function updateApiStatus(status, message) {
            const statusEl = document.getElementById('apiStatus');
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }

        function showResult(elementId, content, type = 'info') {
            const el = document.getElementById(elementId);
            el.className = `result ${type}`;
            el.textContent = content;
            el.style.display = 'block';
        }

        function updateTokenStatus() {
            const statusEl = document.getElementById('tokenStatus');
            const buttons = ['objectivesBtn', 'keyResultsBtn', 'tasksBtn', 'statsBtn', 'getCurrentUserBtn'];
            
            if (currentToken) {
                statusEl.textContent = 'å·²ç™»å½• âœ…';
                statusEl.style.color = '#28a745';
                buttons.forEach(id => {
                    document.getElementById(id).disabled = false;
                });
            } else {
                statusEl.textContent = 'æœªç™»å½• âŒ';
                statusEl.style.color = '#dc3545';
                buttons.forEach(id => {
                    document.getElementById(id).disabled = true;
                });
            }
        }

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json().catch(() => ({}));
                
                return {
                    status: response.status,
                    statusText: response.statusText,
                    data: data,
                    success: response.ok
                };
            } catch (error) {
                return {
                    status: 0,
                    statusText: 'Network Error',
                    data: { error: error.message },
                    success: false
                };
            }
        }

        async function testBasicHealth() {
            const result = await makeRequest(API_BASE);
            
            if (result.success) {
                updateApiStatus('success', 'âœ… è¿è¡Œä¸­');
                showResult('healthResult', 
                    `âœ… APIæœåŠ¡å™¨æ­£å¸¸è¿è¡Œ\nçŠ¶æ€ç : ${result.status}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`, 
                    'success');
            } else {
                updateApiStatus('error', 'âŒ å¼‚å¸¸');
                showResult('healthResult', 
                    `âŒ APIæœåŠ¡å™¨å¼‚å¸¸\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${result.statusText}`, 
                    'error');
            }
        }

        async function testHealthEndpoints() {
            const endpoints = [
                { name: 'åŸºç¡€å¥åº·æ£€æŸ¥', url: `${API_URL}/health` },
                { name: 'ç³»ç»ŸçŠ¶æ€', url: `${API_URL}/health/status` },
                { name: 'æ•°æ®åº“è¿æ¥', url: `${API_URL}/health/db` },
                { name: 'ç³»ç»ŸæŒ‡æ ‡', url: `${API_URL}/health/metrics` }
            ];

            let results = 'å¥åº·æ£€æŸ¥ç«¯ç‚¹æµ‹è¯•ç»“æœ:\n\n';

            for (const endpoint of endpoints) {
                const result = await makeRequest(endpoint.url);
                results += `${endpoint.name}: ${result.success ? 'âœ…' : 'âŒ'} (${result.status})\n`;
                if (!result.success) {
                    results += `  é”™è¯¯: ${result.data.error || result.statusText}\n`;
                }
            }

            showResult('healthResult', results, 'info');
        }

        async function testRegister() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;

            if (!email || !password || !firstName || !lastName) {
                showResult('authResult', 'âŒ è¯·å¡«å†™æ‰€æœ‰æ³¨å†Œå­—æ®µ', 'error');
                return;
            }

            const result = await makeRequest(`${API_URL}/auth/register`, {
                method: 'POST',
                body: JSON.stringify({
                    email,
                    password,
                    confirmPassword: password,
                    firstName,
                    lastName
                })
            });

            if (result.success) {
                showResult('authResult', 
                    `âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸ\nçŠ¶æ€ç : ${result.status}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`, 
                    'success');
            } else {
                showResult('authResult', 
                    `âŒ ç”¨æˆ·æ³¨å†Œå¤±è´¥\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        async function testLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showResult('authResult', 'âŒ è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
                return;
            }

            const result = await makeRequest(`${API_URL}/auth/login`, {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });

            if (result.success && result.data.token) {
                currentToken = result.data.token;
                updateTokenStatus();
                showResult('authResult', 
                    `âœ… ç”¨æˆ·ç™»å½•æˆåŠŸ\nçŠ¶æ€ç : ${result.status}\nToken: ${currentToken.substring(0, 20)}...\nç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(result.data.user, null, 2)}`, 
                    'success');
            } else {
                showResult('authResult', 
                    `âŒ ç”¨æˆ·ç™»å½•å¤±è´¥\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        async function testGetCurrentUser() {
            if (!currentToken) {
                showResult('authResult', 'âŒ è¯·å…ˆç™»å½•è·å–Token', 'error');
                return;
            }

            const result = await makeRequest(`${API_URL}/auth/me`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });

            if (result.success) {
                showResult('authResult', 
                    `âœ… è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯æˆåŠŸ\nçŠ¶æ€ç : ${result.status}\nç”¨æˆ·ä¿¡æ¯: ${JSON.stringify(result.data, null, 2)}`, 
                    'success');
            } else {
                showResult('authResult', 
                    `âŒ è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥\nçŠ¶æ€ç : ${result.status}\né”™è¯¯: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        async function testObjectives() {
            const result = await makeRequest(`${API_URL}/objectives`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });

            showResult('coreResult', 
                `ç›®æ ‡APIæµ‹è¯•ç»“æœ:\nçŠ¶æ€ç : ${result.status}\n${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`, 
                result.success ? 'success' : 'error');
        }

        async function testKeyResults() {
            const result = await makeRequest(`${API_URL}/key-results`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });

            showResult('coreResult', 
                `å…³é”®ç»“æœAPIæµ‹è¯•ç»“æœ:\nçŠ¶æ€ç : ${result.status}\n${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`, 
                result.success ? 'success' : 'error');
        }

        async function testTasks() {
            const result = await makeRequest(`${API_URL}/tasks`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });

            showResult('coreResult', 
                `ä»»åŠ¡APIæµ‹è¯•ç»“æœ:\nçŠ¶æ€ç : ${result.status}\n${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`, 
                result.success ? 'success' : 'error');
        }

        async function testStats() {
            const result = await makeRequest(`${API_URL}/stats/overview`, {
                headers: {
                    'Authorization': `Bearer ${currentToken}`
                }
            });

            showResult('coreResult', 
                `ç»Ÿè®¡APIæµ‹è¯•ç»“æœ:\nçŠ¶æ€ç : ${result.status}\n${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`, 
                result.success ? 'success' : 'error');
        }

        async function testUnauthorizedAccess() {
            const result = await makeRequest(`${API_URL}/objectives`);

            if (result.status === 401) {
                showResult('securityResult', 
                    `âœ… æœªæˆæƒè®¿é—®ä¿æŠ¤æ­£å¸¸\nçŠ¶æ€ç : ${result.status}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`, 
                    'success');
            } else {
                showResult('securityResult', 
                    `âŒ æœªæˆæƒè®¿é—®ä¿æŠ¤å¼‚å¸¸\nçŠ¶æ€ç : ${result.status}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        async function testInvalidToken() {
            const result = await makeRequest(`${API_URL}/objectives`, {
                headers: {
                    'Authorization': 'Bearer invalid_token_123'
                }
            });

            if (result.status === 401) {
                showResult('securityResult', 
                    `âœ… æ— æ•ˆTokenä¿æŠ¤æ­£å¸¸\nçŠ¶æ€ç : ${result.status}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`, 
                    'success');
            } else {
                showResult('securityResult', 
                    `âŒ æ— æ•ˆTokenä¿æŠ¤å¼‚å¸¸\nçŠ¶æ€ç : ${result.status}\nå“åº”: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        async function testPerformance() {
            showResult('performanceResult', 'æ­£åœ¨æµ‹è¯•APIå“åº”æ—¶é—´...', 'info');
            
            const startTime = performance.now();
            const result = await makeRequest(`${API_URL}/health`);
            const endTime = performance.now();
            const responseTime = Math.round(endTime - startTime);

            let message = `APIå“åº”æ—¶é—´æµ‹è¯•ç»“æœ:\nå“åº”æ—¶é—´: ${responseTime}ms\n`;
            
            if (responseTime < 1000) {
                message += `âœ… å“åº”æ—¶é—´ä¼˜ç§€ (< 1000ms)`;
                showResult('performanceResult', message, 'success');
            } else if (responseTime < 2000) {
                message += `âš ï¸ å“åº”æ—¶é—´è‰¯å¥½ (< 2000ms)`;
                showResult('performanceResult', message, 'info');
            } else {
                message += `âŒ å“åº”æ—¶é—´è¾ƒæ…¢ (>= 2000ms)`;
                showResult('performanceResult', message, 'error');
            }
        }
    </script>
</body>
</html> 