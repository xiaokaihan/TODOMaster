name: ğŸš€ Deploy to Production (Vercel + Railway)

on:
  push:
    branches: [ main, master ]
    paths:
      - 'packages/**'
      - '.github/workflows/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  NODE_VERSION: '18'

jobs:
  test:
    name: ğŸ§ª è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: yarn install --frozen-lockfile

      - name: ğŸ—ï¸ æ„å»ºå…±äº«åŒ…
        run: yarn workspace @todomaster/shared build

      - name: ğŸ§ª è¿è¡Œåç«¯æµ‹è¯•
        run: |
          cd packages/backend
          npm run test
        env:
          NODE_ENV: test

      - name: ğŸ§ª è¿è¡Œå‰ç«¯æµ‹è¯•
        run: |
          cd packages/frontend
          npm run test

  deploy-backend:
    name: ğŸ”§ éƒ¨ç½²åç«¯ (Railway)
    runs-on: ubuntu-latest
    needs: test
    outputs:
      backend-url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: yarn install --frozen-lockfile

      - name: ğŸ—ï¸ æ„å»ºå…±äº«åŒ…
        run: yarn workspace @todomaster/shared build

      - name: ğŸ—ï¸ æ„å»ºåç«¯
        run: |
          cd packages/backend
          npm run build

      - name: ğŸš€ éƒ¨ç½²åˆ° Railway
        id: deploy
        run: |
          npm install -g @railway/cli
          cd packages/backend
          
          # éƒ¨ç½²åˆ° Railway
          railway up --detach
          
          # ç­‰å¾…éƒ¨ç½²å®Œæˆå¹¶è·å–URL
          sleep 30
          BACKEND_URL=$(railway status --json | jq -r '.deployments[0].url' || echo "")
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "âœ… åç«¯éƒ¨ç½²å®Œæˆ: $BACKEND_URL"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

  deploy-frontend:
    name: ğŸ¨ éƒ¨ç½²å‰ç«¯ (Vercel)
    runs-on: ubuntu-latest
    needs: [test, deploy-backend]
    steps:
      - name: ğŸ“¥ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: yarn install --frozen-lockfile

      - name: ğŸ—ï¸ æ„å»ºå…±äº«åŒ…
        run: yarn workspace @todomaster/shared build

      - name: âš™ï¸ è®¾ç½®ç¯å¢ƒå˜é‡
        run: |
          cd packages/frontend
          echo "VITE_API_URL=${{ needs.deploy-backend.outputs.backend-url }}/api/v1" > .env.production

      - name: ğŸ—ï¸ æ„å»ºå‰ç«¯
        run: |
          cd packages/frontend
          npm run build:vercel

      - name: ğŸš€ éƒ¨ç½²åˆ° Vercel
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-args: '--prod'
          vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
          vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
          working-directory: packages/frontend

  health-check:
    name: ğŸ” å¥åº·æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    steps:
      - name: ğŸ” æ£€æŸ¥åç«¯æœåŠ¡
        run: |
          BACKEND_URL="${{ needs.deploy-backend.outputs.backend-url }}"
          if [ -n "$BACKEND_URL" ]; then
            echo "æ£€æŸ¥åç«¯æœåŠ¡: $BACKEND_URL"
            for i in {1..5}; do
              if curl -f "$BACKEND_URL/health"; then
                echo "âœ… åç«¯æœåŠ¡æ­£å¸¸"
                break
              else
                echo "â³ ç­‰å¾…åç«¯æœåŠ¡å¯åŠ¨... ($i/5)"
                sleep 30
              fi
            done
          fi

      - name: ğŸ“Š éƒ¨ç½²æ€»ç»“
        run: |
          echo "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo "ğŸ“‹ éƒ¨ç½²ä¿¡æ¯:"
          echo "   - ç¯å¢ƒ: Production"
          echo "   - åç«¯: Railway (${{ needs.deploy-backend.outputs.backend-url }})"
          echo "   - å‰ç«¯: Vercel"
          echo "   - åˆ†æ”¯: ${{ github.ref_name }}"
          echo "   - æäº¤: ${{ github.sha }}"

  notify:
    name: ğŸ“¢ é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend, health-check]
    if: always()
    steps:
      - name: ğŸ“¢ å‘é€é€šçŸ¥
        run: |
          if [ "${{ needs.health-check.result }}" == "success" ]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
            echo "ğŸ”— å‰ç«¯åœ°å€: https://${{ secrets.VERCEL_PROJECT_ID }}.vercel.app"
            echo "ğŸ”— åç«¯åœ°å€: ${{ needs.deploy-backend.outputs.backend-url }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi 